# 系统管理员功能实现说明文档

## 一、功能概述

本次实现为系统管理员权限界面添加了完整的管理功能，包括：
1. 用户管理（增删改查）
2. 部门管理（增删改查）
3. 岗位管理（增删改查）
4. 角色分配（为用户分配角色）
5. 查看全部审批数据（只读）

**注意**：管理员Dashboard中已移除"全部申请"、"待办任务"和"已办任务"模块，这些功能仅保留在普通用户界面中。管理员界面专注于系统管理功能。

## 二、后端实现

### 2.1 实体类（Entity）

#### Dept.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/entity/Dept.java`
- 功能：部门实体类，映射数据库表 `sys_dept`
- 字段：部门ID、父部门ID、部门名称、负责人、联系电话、邮箱、排序、状态、删除标志、创建时间、更新时间

#### Post.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/entity/Post.java`
- 功能：岗位实体类，映射数据库表 `sys_post`
- 字段：岗位ID、岗位编码、岗位名称、排序、状态、删除标志、创建时间、更新时间

### 2.2 Mapper接口

#### DeptMapper.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/mapper/DeptMapper.java`
- 功能：部门数据访问层，继承 MyBatis-Plus 的 BaseMapper

#### PostMapper.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/mapper/PostMapper.java`
- 功能：岗位数据访问层，继承 MyBatis-Plus 的 BaseMapper

#### UserMapper.java（已更新）
- 位置：`approval-backend/src/main/java/com/approval/module/system/mapper/UserMapper.java`
- 新增方法：
  - `selectRolesByUserId`：查询用户的角色列表
  - `insertUserRole`：插入用户角色关联
  - `deleteUserRole`：删除用户角色关联

### 2.3 DTO类（数据传输对象）

#### UserDto.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/dto/UserDto.java`
- 功能：用户数据传输对象，用于接收前端提交的用户数据
- 包含验证注解：用户名、真实姓名、手机号、邮箱格式验证

#### DeptDto.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/dto/DeptDto.java`
- 功能：部门数据传输对象
- 包含验证注解：部门名称、邮箱格式验证

#### PostDto.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/dto/PostDto.java`
- 功能：岗位数据传输对象
- 包含验证注解：岗位编码、岗位名称验证

#### AssignRolesDto.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/dto/AssignRolesDto.java`
- 功能：角色分配数据传输对象
- 字段：用户ID、角色ID列表

### 2.4 VO类（视图对象）

#### UserVo.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/vo/UserVo.java`
- 功能：用户视图对象，用于返回给前端的用户数据
- 扩展字段：部门名称、岗位名称、角色列表

#### DeptVo.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/vo/DeptVo.java`
- 功能：部门视图对象
- 扩展字段：父部门名称

#### PostVo.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/vo/PostVo.java`
- 功能：岗位视图对象

### 2.5 Service层

#### IAdminService.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/service/IAdminService.java`
- 功能：系统管理服务接口
- 方法列表：
  - 用户管理：`getUserList`、`getUserById`、`createUser`、`updateUser`、`deleteUser`
  - 部门管理：`getDeptList`、`getDeptById`、`createDept`、`updateDept`、`deleteDept`
  - 岗位管理：`getPostList`、`getPostById`、`createPost`、`updatePost`、`deletePost`
  - 角色管理：`assignRoles`、`getAllDepts`、`getAllPosts`、`getAllRoles`

#### AdminServiceImpl.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/service/impl/AdminServiceImpl.java`
- 功能：系统管理服务实现类
- 核心逻辑：
  - 用户管理：支持按用户名、真实姓名、部门、状态筛选；密码加密；关联部门、岗位、角色信息
  - 部门管理：支持按部门名称、状态筛选；支持父子部门关系；删除前检查子部门和用户
  - 岗位管理：支持按岗位名称、状态筛选；删除前检查用户
  - 角色分配：先删除用户原有角色，再插入新角色

### 2.6 Controller层

#### AdminController.java
- 位置：`approval-backend/src/main/java/com/approval/module/system/controller/AdminController.java`
- 功能：系统管理控制器
- 接口列表：
  - `GET /admin/users`：获取用户列表（支持分页和筛选）
  - `GET /admin/users/{userId}`：获取用户详情
  - `POST /admin/users`：创建用户
  - `PUT /admin/users`：更新用户
  - `DELETE /admin/users/{userId}`：删除用户
  - `GET /admin/depts`：获取部门列表
  - `GET /admin/depts/{deptId}`：获取部门详情
  - `POST /admin/depts`：创建部门
  - `PUT /admin/depts`：更新部门
  - `DELETE /admin/depts/{deptId}`：删除部门
  - `GET /admin/posts`：获取岗位列表
  - `GET /admin/posts/{postId}`：获取岗位详情
  - `POST /admin/posts`：创建岗位
  - `PUT /admin/posts`：更新岗位
  - `DELETE /admin/posts/{postId}`：删除岗位
  - `POST /admin/users/roles`：分配角色
  - `GET /admin/depts/all`：获取所有部门（用于下拉选择）
  - `GET /admin/posts/all`：获取所有岗位（用于下拉选择）
  - `GET /admin/roles/all`：获取所有角色（用于下拉选择）

#### AdminApplicationController.java
- 位置：`approval-backend/src/main/java/com/approval/module/approval/controller/AdminApplicationController.java`
- 功能：系统管理员审批数据控制器（只读）
- 接口列表：
  - `GET /admin/applications`：获取全部审批数据（支持分页和筛选）
  - `GET /admin/applications/{appId}`：获取审批数据详情

## 三、前端实现

### 3.1 类型定义

#### types/index.ts（已更新）
- 新增类型：
  - `AdminUser`：管理员用户信息
  - `AdminDept`：管理员部门信息
  - `AdminPost`：管理员岗位信息
  - `AdminRole`：管理员角色信息
  - `UserFormData`：用户表单数据
  - `DeptFormData`：部门表单数据
  - `PostFormData`：岗位表单数据
  - `AssignRolesData`：角色分配数据

### 3.2 API接口

#### api/admin.ts
- 位置：`frontend/src/api/admin.ts`
- 功能：系统管理API接口封装
- 方法列表：
  - `getUserList`：获取用户列表
  - `getUserById`：获取用户详情
  - `createUser`：创建用户
  - `updateUser`：更新用户
  - `deleteUser`：删除用户
  - `getDeptList`：获取部门列表
  - `getDeptById`：获取部门详情
  - `createDept`：创建部门
  - `updateDept`：更新部门
  - `deleteDept`：删除部门
  - `getPostList`：获取岗位列表
  - `getPostById`：获取岗位详情
  - `createPost`：创建岗位
  - `updatePost`：更新岗位
  - `deletePost`：删除岗位
  - `assignRoles`：分配角色
  - `getAllDepts`：获取所有部门
  - `getAllPosts`：获取所有岗位
  - `getAllRoles`：获取所有角色
  - `getAllApplications`：获取全部审批数据
  - `getApplicationDetail`：获取审批数据详情

### 3.3 页面组件

#### UserManagement.tsx
- 位置：`frontend/src/pages/UserManagement.tsx`
- 功能：用户管理页面
- 功能特性：
  - 用户列表展示（支持分页）
  - 按用户名、真实姓名、部门、状态筛选
  - 新增用户（弹窗表单）
  - 编辑用户（弹窗表单）
  - 删除用户（确认提示）
  - 显示用户的部门、岗位、角色信息

#### DeptManagement.tsx
- 位置：`frontend/src/pages/DeptManagement.tsx`
- 功能：部门管理页面
- 功能特性：
  - 部门列表展示
  - 按部门名称、状态筛选
  - 新增部门（支持选择父部门）
  - 编辑部门
  - 删除部门（确认提示）
  - 显示父部门信息

#### PostManagement.tsx
- 位置：`frontend/src/pages/PostManagement.tsx`
- 功能：岗位管理页面
- 功能特性：
  - 岗位列表展示
  - 按岗位名称、状态筛选
  - 新增岗位
  - 编辑岗位
  - 删除岗位（确认提示）

#### RoleAssignment.tsx
- 位置：`frontend/src/pages/RoleAssignment.tsx`
- 功能：角色分配页面
- 功能特性：
  - 用户列表展示
  - 显示用户当前角色
  - 为用户分配角色（弹窗多选）
  - 支持多角色分配

#### AllApplications.tsx
- 位置：`frontend/src/pages/AllApplications.tsx`
- 功能：审批数据查看页面（只读）
- 功能特性：
  - 全部审批数据列表展示
  - 按申请单号、类型、状态筛选
  - 显示申请单号、类型、标题、申请人、部门、状态、提交时间

### 3.4 UI组件

#### checkbox.tsx（新增）
- 位置：`frontend/src/components/ui/checkbox.tsx`
- 功能：复选框组件，用于角色分配页面的多选

### 3.5 路由配置

#### AdminDashboard.tsx（已更新）
- 位置：`frontend/src/pages/AdminDashboard.tsx`
- 更新内容：
  - 移除导航菜单项：全部申请、待办任务、已办任务
  - 保留导航菜单项：用户管理、部门管理、岗位管理、角色分配、审批数据
  - 新增路由配置：
    - `/dashboard/users` → UserManagement
    - `/dashboard/depts` → DeptManagement
    - `/dashboard/posts` → PostManagement
    - `/dashboard/roles` → RoleAssignment
    - `/dashboard/all-applications` → AllApplications
  - 更新首页快捷按钮为：用户管理、部门管理、审批数据
  - 移除相关组件导入：MyApplications、TodoTasks、DoneTasks
  - 移除相关图标导入：FileText、CheckSquare、ClipboardList

## 四、数据库表结构

### 4.1 sys_user（用户表）
已存在，新增字段关联：
- `dept_id`：部门ID
- `post_id`：岗位ID

### 4.2 sys_dept（部门表）
已存在，包含字段：
- `dept_id`：部门ID
- `parent_id`：父部门ID
- `dept_name`：部门名称
- `leader`：负责人
- `phone`：联系电话
- `email`：邮箱
- `order_num`：排序
- `status`：状态
- `del_flag`：删除标志

### 4.3 sys_post（岗位表）
已存在，包含字段：
- `post_id`：岗位ID
- `post_code`：岗位编码
- `post_name`：岗位名称
- `post_sort`：排序
- `status`：状态
- `del_flag`：删除标志

### 4.4 sys_role（角色表）
已存在，包含字段：
- `role_id`：角色ID
- `role_name`：角色名称
- `role_key`：角色权限字符串
- `role_sort`：排序
- `status`：状态
- `del_flag`：删除标志

### 4.5 sys_user_role（用户角色关联表）
已存在，包含字段：
- `user_id`：用户ID
- `role_id`：角色ID

## 五、前后端交互流程

### 5.1 用户管理流程
1. 前端调用 `adminApi.getUserList()` 获取用户列表
2. 后端 `AdminController.getUserList()` 接收请求
3. 后端 `AdminServiceImpl.getUserList()` 查询数据库
4. 后端关联查询部门、岗位、角色信息
5. 返回用户列表数据给前端
6. 前端展示用户列表

### 5.2 角色分配流程
1. 前端点击"分配角色"按钮，弹出角色选择对话框
2. 前端调用 `adminApi.getAllRoles()` 获取所有角色
3. 用户选择角色后，前端调用 `adminApi.assignRoles()` 提交
4. 后端 `AdminController.assignRoles()` 接收请求
5. 后端 `AdminServiceImpl.assignRoles()` 先删除用户原有角色，再插入新角色
6. 返回成功结果，前端刷新用户列表

### 5.3 审批数据查看流程
1. 前端调用 `adminApi.getAllApplications()` 获取审批数据
2. 后端 `AdminApplicationController.getAllApplications()` 接收请求
3. 后端查询 `bpm_application` 表，支持按类型、状态、申请单号筛选
4. 后端关联查询申请人信息
5. 返回审批数据列表给前端
6. 前端展示审批数据（只读，不可修改）

## 六、代码风格说明

### 6.1 后端代码风格
- 使用 Lombok 注解简化代码（@Data、@RequiredArgsConstructor）
- 使用 MyBatis-Plus 进行数据库操作
- 使用 Spring Boot 3.x 和 Spring Security 6.x
- 使用 Swagger 3.0 生成 API 文档
- 统一返回 Result 对象封装响应数据
- 使用 @Valid 注解进行参数校验

### 6.2 前端代码风格
- 使用 React + TypeScript
- 使用 Tailwind CSS 进行样式设计
- 使用 shadcn/ui 组件库
- 使用 React Router 进行路由管理
- 使用 Zustand 进行状态管理
- 统一使用 async/await 处理异步请求
- 使用 Dialog 组件实现弹窗表单

## 七、权限控制

### 7.1 后端权限
- 当前实现未添加 @PreAuthorize 注解进行权限控制
- 建议在后续版本中添加权限注解，确保只有系统管理员可以访问这些接口

### 7.2 前端权限
- 当前实现通过路由控制，只有系统管理员可以访问管理员Dashboard
- 建议在后续版本中添加更细粒度的权限控制

## 八、测试建议

### 8.1 后端测试
1. 测试用户CRUD操作
2. 测试部门CRUD操作
3. 测试岗位CRUD操作
4. 测试角色分配功能
5. 测试审批数据查询功能
6. 测试数据验证（如必填字段、格式验证）
7. 测试删除前的关联检查

### 8.2 前端测试
1. 测试页面加载和数据显示
2. 测试筛选功能
3. 测试新增/编辑/删除操作
4. 测试弹窗表单的提交和取消
5. 测试角色分配的多选功能
6. 测试审批数据的只读展示

## 九、注意事项

1. **密码安全**：创建用户时，密码使用 BCrypt 加密存储
2. **删除保护**：删除部门前检查是否有子部门和用户；删除岗位前检查是否有用户
3. **角色分配**：分配角色时先删除原有角色，再插入新角色，避免重复
4. **数据验证**：后端使用 @Valid 注解进行参数验证，确保数据完整性
5. **只读权限**：审批数据查看页面只提供只读功能，不允许修改
6. **代码风格**：遵循项目现有的代码风格和命名规范

## 十、问题修复与优化

### 10.1 前端问题修复

#### 问题1：SelectItem 空字符串错误
- **问题描述**：Radix UI Select 组件不允许 SelectItem 的 value 属性为空字符串
- **错误信息**：`A <Select.Item /> must have a value prop that is not an empty string`
- **修复方案**：
  - 将所有 `<SelectItem value="">` 改为 `<SelectItem value="all">`
  - 更新 `onValueChange` 处理逻辑，当选择 "all" 时将 filter 值设置为空字符串
- **影响文件**：
  - `frontend/src/pages/UserManagement.tsx`
  - `frontend/src/pages/DeptManagement.tsx`
  - `frontend/src/pages/PostManagement.tsx`
  - `frontend/src/pages/AllApplications.tsx`

#### 问题2：缺少依赖包
- **问题描述**：checkbox 组件需要 @radix-ui/react-checkbox 依赖，但 package.json 中未包含
- **修复方案**：
  - 在 `frontend/package.json` 中添加 `"@radix-ui/react-checkbox": "^1.0.4"`
  - 需要运行 `npm install` 安装依赖
- **影响文件**：
  - `frontend/package.json`

#### 问题3：useEffect 依赖项问题
- **问题描述**：UserManagement 组件中 useEffect 的依赖项包含 filter，导致每次 filter 变化都会重新获取部门和岗位数据
- **修复方案**：
  - 将 fetchUsers 的 useEffect 依赖设为 [filter]
  - 将 fetchDepts 和 fetchPosts 的 useEffect 依赖设为 []（只在组件挂载时执行一次）
- **影响文件**：
  - `frontend/src/pages/UserManagement.tsx`

### 10.2 后端问题修复

#### 问题1：Result.error() 方法不存在
- **问题描述**：AdminApplicationController 中使用了 Result.error() 方法，但 Result 类中只有 fail() 方法
- **错误信息**：`java: 找不到符号 符号: 方法 error(int,java.lang.String) 位置: 类 com.approval.common.result.Result`
- **修复方案**：
  - 将 `Result.error(404, "申请不存在")` 改为 `Result.fail(404, "申请不存在")`
- **影响文件**：
  - `approval-backend/src/main/java/com/approval/module/approval/controller/AdminApplicationController.java`

### 10.3 调试日志增强

为了方便问题排查，在以下文件中添加了详细的调试日志：
- `frontend/src/pages/UserManagement.tsx`：添加用户、部门、岗位数据获取日志
- `frontend/src/pages/DeptManagement.tsx`：添加部门数据获取日志
- `frontend/src/pages/PostManagement.tsx`：添加岗位数据获取日志

日志示例：
```typescript
console.log('用户数据:', res)
console.error('获取用户列表失败:', error)
```

### 10.4 依赖安装说明

在完成代码修改后，需要执行以下步骤安装依赖：

```bash
cd c:\Users\21757\Desktop\新建文件夹\YIR-ApprovalHub\frontend
npm install
```

如果遇到 PowerShell 执行策略限制，可以：
1. 以管理员身份运行 PowerShell
2. 执行 `Set-ExecutionPolicy RemoteSigned`
3. 然后再运行 `npm install`

或者直接在命令提示符（cmd）中运行 `npm install`。

## 十一、后续优化建议

1. **权限控制**：添加 @PreAuthorize 注解进行细粒度权限控制
2. **批量操作**：支持批量删除用户、批量分配角色等功能
3. **数据导出**：支持导出用户、部门、岗位数据为 Excel
4. **操作日志**：记录管理员的所有操作，便于审计
5. **数据缓存**：对部门、岗位等基础数据进行缓存，提高查询性能
6. **前端优化**：添加加载动画、错误提示、成功提示等交互优化
7. **表单验证**：增强前端表单验证，提供更好的用户体验
